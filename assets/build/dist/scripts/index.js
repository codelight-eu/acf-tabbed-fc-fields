!function(a,b,c){var d=b.fields.flexible_content;d.fields={},d._remove_event=function(c){var d=this,e=c.substr(0,c.indexOf(" ")),f=c.substr(c.indexOf(" ")+1),g=b.get_selector(d.type);a(document).off(e,g+" "+f)},d._remove_action=function(a){var c=this,d=a+"_field/type="+c.type;b.remove_action(d)},d.extend=function(b){for(var c in this.events)this._remove_event(c,this.events[c]);for(var d in this.actions)this._remove_action(d);var e=a.extend({},this,b);return a.each(e.actions,function(a,b){e._add_action(a,b)}),a.each(e.filters,function(a,b){e._add_filter(a,b)}),a.each(e.events,function(a,b){e._add_event(a,b)}),e},b.fields.flexible_content=d.extend({actions:{ready:"initialize",append:"initialize",show:"show"},events:{'click [data-event="add-layout"]':"_open",'click [data-event="remove-layout"]':"_remove","click .acf-fc-popup a":"_add","blur .acf-fc-popup .focus":"_close","mouseenter .ui-tabs-nav":"_mouseenter"},focus:function(){this.key();this.$el=this.$field.find(".acf-flexible-content:first"),this.$input=this.$el.siblings("input"),this.$clones=this.$el.children(".clones"),this.$tabs=this.$el.children(".tabs"),this.$tabs_nav=this.$tabs.children("ul").first(),this.tabs=this.data(),this.o=b.get_data(this.$el),this.o.min=this.o.min||0,this.o.max=this.o.max||0,this.init_tabs()},key:function(){return this.$field.data("key")},data:function(a){var b=this.key(),c=d.fields[b];return c&&!a||(c=d.fields[b]={tabs:[],active:c?c.active:0,initialized:!1,key:b}),c},initialized:function(){return this.data().initialized},count:function(){return this.tabs.tabs.length},count_layouts:function(a){return c.reduce(this.tabs.tabs,function(b,c){return b+(c.layout===a?1:0)},0)},initialize:function(){this.initialized()||(this.data().initialized=!0,this.$clones.find("input, textarea, select").attr("disabled","disabled"))},init_tabs:function(){var c=this,d=(this.key(),this.data(!0)),e=d.tabs;this.$tabs.tabs().tabs("destroy"),this.$tabs.children(".tab").each(function(b){var c=a(this);e[b]={$tab:c,layout:c.data("layout")}}),this.$tabs.tabs({active:d.active,heightStyle:"content",create:function(a,b){},beforeActivate:function(a,b){},activate:function(a,b){c.data().active=c.get_active_tab_index()}}),this.$tabs_nav.sortable({axis:"y",items:"> li",scroll:!0,start:function(a,d){var e=d.item.find("a").first().attr("href"),f=c.$el.find(e).find("> .layout:eq(0)");b.do_action("sortstart",f,d.placeholder)},stop:function(a,d){var e=d.item.find("a").first().attr("href"),f=c.$el.find(e).find("> .layout:eq(0)");c.reorder_tabs(a,d),c.init_tabs(),b.do_action("sortstop",f,d.placeholder)},update:function(a,b){c.$input.trigger("change")}})},show:function(){var c=this.tabs.tabs;for(var d in c){var e=c[d];e.$tab.find(".acf-field:visible").each(function(){b.do_action("show_field",a(this))})}},get_active_tab_index:function(){return this.$tabs.tabs("option","active")},get_active_tab:function(){return this.tabs[this.get_active_tab_index()]},render:function(){0==this.count()&&0==this.tabs.active?this.$el.addClass("-empty"):this.$el.removeClass("-empty"),this.$el.find("> .acf-actions .button").toggleClass("disabled",this.o.max>0&&this.count()>=this.o.max),this.$tabs.tabs("refresh")},validate_add:function(c){if(this.o.max>0&&this.count()>=this.o.max){var d=1==this.o.max?"layout":"layouts",e=b._e("flexible_content","max");return e=e.replace("{max}",this.o.max),e=e.replace("{identifier}",b._e("flexible_content",d)),alert(e),!1}var f=a(this.$el.children(".tmpl-popup").html()),g=f.find('[data-layout="'+c+'"]'),h=parseInt(g.attr("data-max")),i=this.count_layouts(c);if(h>0&&i>=h){var d=1==h?"layout":"layouts",e=b._e("flexible_content","max_layout");return e=e.replace("{max}",i),e=e.replace("{label}",'"'+g.text()+'"'),e=e.replace("{identifier}",b._e("flexible_content",d)),alert(e),!1}return!0},validate_remove:function(c){if(this.o.min>0&&this.count()<=this.o.min){var d=1==this.o.min?"layout":"layouts",e=b._e("flexible_content","min")+", "+b._e("flexible_content","remove");return e=e.replace("{min}",this.o.min),e=e.replace("{identifier}",b._e("flexible_content",d)),e=e.replace("{layout}",b._e("flexible_content","layout")),confirm(e)}var f=a(this.$el.children(".tmpl-popup").html()),g=f.find('[data-layout="'+c+'"]'),h=parseInt(g.attr("data-min")),i=this.count_layouts(c);if(h>0&&i<=h){var d=1==h?"layout":"layouts",e=b._e("flexible_content","min_layout")+", "+b._e("flexible_content","remove");return e=e.replace("{min}",i),e=e.replace("{label}",'"'+g.text()+'"'),e=e.replace("{identifier}",b._e("flexible_content",d)),e=e.replace("{layout}",b._e("flexible_content","layout")),confirm(e)}return!0},add:function(c,d){if(d=d||!1,!this.validate_add(c))return!1;var e=this.$field,f=this.$clones.children('.layout[data-layout="'+c+'"]'),g=b.duplicate(f);g.find("input, textarea, select").not(".acf-disabled").removeAttr("disabled"),this.$el.children(".no-value-message").hide();var h="tab-"+b.get_uniqid()+"-"+b.get_uniqid(),i={layout:c,$tab:a("<div />").attr("id",h).addClass("tab").attr("data-layout",c).append(g),$tab_hndl:a("<li/>").attr("data-id",h).append(a("<a/>").attr("href","#"+h).text(g.data("layout-label")))};this.tabs.tabs.push(i),this.$tabs_nav.append(i.$tab_hndl),this.$tabs.append(i.$tab),b.validation.remove_error(this.$field),this.init_tabs(),this.render();var j=this.count()-1,k=j>=0?j:0;this.$tabs.tabs("option","active",k),this.doFocus(e)},reorder_tabs:function(b,c){var d=this.$tabs_nav.children("li"),e=a(c.item),f=d.index(e),g=e.data("id"),h=this.$tabs.find("#"+g),i=d.length-1;switch(f){case 0:var j=this.$tabs.children(".ui-tabs-nav");j.attr("id")!=h.attr("id")&&h.detach().insertAfter(j);break;case i:var j=this.$tabs.children(".tab").last();j.attr("id")!=h.attr("id")&&h.detach().insertAfter(j);break;default:Math.abs(c.position.top-c.originalPosition.top)>30&&(c.position.top<c.originalPosition.top?h.detach().insertBefore(this.$tabs.children(".tab").eq(f)):h.detach().insertAfter(this.$tabs.children(".tab").eq(f)))}},_open:function(c){var d=this,e=a(this.$el.children(".tmpl-popup").html());e.find("ul li a").each(function(){var c=a(this),e=c.data("min")||0,f=c.data("max")||0,g=c.data("layout"),h=d.count_layouts(g);if(f&&h>=f)return void c.addClass("disabled");if(e){var i=e-h,j=b._e("flexible_content","required"),k=1==i?"layout":"layouts",j=j.replace("{required}",i);if(j=j.replace("{min}",e),j=j.replace("{label} ",""),j=j.replace("{identifier}",b._e("flexible_content",k)),i>0){var l=a('<span class="badge"></span>').attr("title",j).text(i);c.append(l)}}});var f=null;c.$el.closest(".acf-fc-layout-controlls").exists()&&(f=e.closest(".layout"),f.addClass("-open")),a("body").append(e),this.position_popup(e,c.$el);var g=function(b,c){b.preventDefault(),b.stopImmediatePropagation(),e.off("click","a",h),a("body").off("click",i),e.remove(),null!==f&&f.removeClass("-open"),null!==c&&d.add(c,f)},h=function(b){g(b,a(this).attr("data-layout"))},i=function(a){g(a,null)};e.on("click","a",h),a("body").on("click",i)},_close:function(a){var b=a.$el.parent(),c=b.closest(".layout");c.removeClass("-open"),setTimeout(function(){b.remove()},200)},_add:function(a){var b=a.$el.closest(".acf-fc-popup"),c=a.$el.attr("data-layout"),d=!1;b.closest(".acf-fc-layout-controlls").exists()&&(d=b.closest(".layout")),this.add(c,d)},_remove:function(a){var c=this,d=a.$el.closest(".layout");if(this.validate_remove(d.attr("data-layout"))){var e=this.$el.children(".no-value-message");b.do_action("remove",d);var f=d.closest(".tab"),g=f.attr("id"),h=this.$tabs.children(".tab").index(f),i=this.$tabs.children("ul").first().find("[data-id="+g+"]");b.remove_el(d,function(){i.remove(),f.remove(),c.tabs.tabs.splice(h,1),c.render(),c.$input.trigger("change"),c.count()||e.show()})}},_mouseenter:function(a){}})}($||jQuery,acf,_||Underscore);